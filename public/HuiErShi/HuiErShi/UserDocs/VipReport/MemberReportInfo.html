<!--会员详情页面-->
<!DOCTYPE html>
<html>
<!--在报告单资源下边有很多的接口  需要查看并修改功能-->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>报告详情</title>
  <link href="../../Styles/bootstrap-3.3.4.css" rel="stylesheet">
  <link href="../../Styles/common.css" rel="stylesheet">
  <style>
    .user-icon {
      max-width: 100px;
      /*height: auto;*/
      height: 100px;
    }
  </style>
</head>

<body ng-app="myApp" ng-controller="customersCtrl">
  <!-- 面包屑导航 -->
  <ol class="breadcrumb col-xs-12" style="border-radius:0;background-color:white;">
    <li><a href="javascript:void(0)">会员报告</a></li>
    <li><a href="javascript:history.back(-1);">报告列表</a></li>
    <li class="active">{{"TODO"}}</li>
  </ol>
  <!--会员详情-->
  <div class="section">
    <div class="container">
      <div class="row">
        <!-- 消除外边距 -->
        <div class="col-md-2">
          <img src='{{data.user.iconUrl==""?"http://usr.im/100x100?text=暂无图片":data.user.iconUrl}}' class='img-responsive img-thumbnail user-icon' alt='自定义'></div>
        <div class="col-md-3">
          <p><b>　　姓名:</b><span><a href="../UserManage/UserInfo.html?id={{reportId}}"> {{data.user.userName}}</a></span></p>
          <p><b>报告单号:</b><span>{{data.reportNo}}</span></p>
        </div>
        <div class="col-md-2">
          <p><b>性别:</b><span>女</span></p>
          <p><b>日期:</b><span>{{data.createAt|date:"yyyy/MM/dd" }}</span></p>
        </div>
        <div class="col-md-2">
          <p><b>年龄:</b><span>18</span></p>
          <p><b>状态:</b>
            <span ng-if="data.status=='0'">检查登记</span>
            <span ng-if="data.status=='1'">专家填写</span>
            <span ng-if="data.status=='2'">待发布</span><span ng-if="data.status=='3'">已发布</span></p>
          <!--检查注册-0， 专家建议已填写-1， 已发布-2-->
        </div>
        <div class="col-md-3">
          <button type="button" class="btn btn-primary pull-right" ng-click="publishReport()">发布报告</button>
        </div>
        <div class="col-md-2"> </div>
        <div class="col-md-6 ">
          <p><b>　　验单:</b>
            <a ng-repeat="x in data.inspections" href="#?id={{x.id}}">{{x.name+" "}}</a>
          </p>
        </div>
      </div>
      <hr>
      <!--// ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆   
          // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆
          // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆
          // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆-->
      <div class="row">
        <!-- 消除外边距 -->
        <div class="col-md-2"><img src='{{expertData.foodUrl==""?"http://usr.im/100x100?text=暂无图片":expertData.foodUrl}}' class='img-responsive img-thumbnail user-icon' alt='自定义'>

          <button type="button" class="btn btn-primary" ng-click="addConsult('food')" style="margin-top:10px;">确认提交</button>
        </div>
        <div class="col-md-10">
          <p><b>报告分析:</b>(<a href="#?" ng-click="editReport(expertData.foodReport,'food')">修改</a>)
            <br>
            <span>　　</span> <span>{{expertData.foodReport}}
             </span>

          </p>
          <p><b>专家建议:</b>(<a href="#?" ng-click="editAdvice(expertData.foodAdvice,'food')">修改</a>)
            <br>
            <span>　　</span> <span>{{expertData.foodAdvice}}</span>


          </p>
        </div>
        <div class="col-md-10 col-md-offset-2">



        </div>
        <div class="col-md-2">
          <a class="btn btn-primary pull-right btn-sm" data-toggle="modal" href="#modal" ng-click="addChufang(expertData.foodId,'food')" style="position:relative;right:-27px;">添加处方</a>
        </div>
        <div class="col-md-10">
          <table class="table  table-hover table-bordered">
            <!-- 表头 -->
            <thead>
              <tr>
                <th> 处方名称 </th>
                <th> 处方类别 </th>
                <th> 拼音名 </th>
                <th> 操作 </th>
              </tr>
            </thead>
            <tbody id="databody">
              <tr ng-show="foodChufangArr.length>0" ng-repeat="x in foodChufangArr">
                <td>{{ x.name }}</td>
                <td>
                  <span ng-if="x.prescriptionType ==''">处方类别</span>
                  <span ng-if="x.prescriptionType =='Sport'">运动</span>
                  <span ng-if="x.prescriptionType =='Nutrition'">营养</span>
                </td>
                <td>{{ x.spell }}</td>
                <td>
                  <a href="#?id={{x.id}}">删除</a></td>
              </tr>
              <tr ng-show="foodChufangArr.length<=0">
                <td colspan="100" class="text-center ">暂无结果</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-10 col-md-offset-2">
          <!--//TODO 上传文件功能未做-->
          <!--<p><b>上传文件:</b> <input type="file" name="" value=""></p>-->
        </div>
      </div>
      <hr>
      <!--// ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆   
          // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆
          // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆
          // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆-->
      <div class="row">
        <!-- 消除外边距 -->
        <div class="col-md-2">

          <img src='{{expertData.sportUrl==""?"http://usr.im/100x100?text=暂无图片":expertData.sportUrl}}' class='img-responsive img-thumbnail user-icon' alt='自定义'>

          <button type="button" class="btn btn-primary" ng-click="addConsult('sport')" style="margin-top:10px;">确认提交</button>
        </div>
        <div class="col-md-10">
          <p id="sportReport"><b>报告分析:</b>(<a href="#?" ng-click="editReport(expertData.sportReport,'sport')">修改</a>)
            <br>
            <span>　　</span> <span class="content">{{expertData.sportReport}}
             </span>
          </p>
          <p id="sportAdvice"><b>专家建议:</b>(<a href="#?" ng-click="editAdvice(expertData.sportAdvice,'sport')">修改</a>)
            <br>
            <span>　　</span> <span class="content">{{expertData.sportAdvice}}</span>


          </p>
        </div>
        <div class="col-md-10 col-md-offset-2">



        </div>
        <div class="col-md-2">
          <a class="btn btn-primary pull-right btn-sm" data-toggle="modal" href="#modal" ng-click="addChufang(expertData.sportId,'sport')" style="position:relative;right:-27px;">添加处方</a>
        </div>
        <div class="col-md-10">
          <table class="table  table-hover table-bordered">
            <!-- 表头 -->
            <thead>
              <tr>
                <th> 处方名称 </th>
                <th> 处方类别 </th>
                <th> 拼音名 </th>
                <th> 操作 </th>
              </tr>
            </thead>
            <tbody id="databody">
              <tr ng-show="sportChufangArr.length>0" ng-repeat="x in sportChufangArr">
                <td>{{ x.name }}</td>
                <td>
                  <span ng-if="x.prescriptionType ==''">处方类别</span>
                  <span ng-if="x.prescriptionType =='Sport'">运动</span>
                  <span ng-if="x.prescriptionType =='Nutrition'">营养</span>
                </td>
                <td>{{ x.spell }}</td>
                <td>
                  <a href="#?id={{x.id}}">删除</a></td>
              </tr>
              <tr ng-show="sportChufangArr.length<=0">
                <td colspan="100" class="text-center ">暂无结果</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-10 col-md-offset-2">
          <!--//TODO 上传文件功能未做-->
          <!--<p><b>上传文件:</b> <input type="file" name="" value=""></p>-->
        </div>
      </div>
      <!--<div class="row">
        <div class="col-md-2"><img src='http://usr.im/100x100?text=文字说明' class='img-responsive img-thumbnail' alt='自定义'></div>
        <div class="col-md-10">
          <p>
            <b>报告分析:</b>{{x.Consult.analysis }}
            <a href="#?">(修改)</a>
          </p>
          <p>
            <b>报告分析:</b>
            <a href="#?">(修改)</a>
          </p>
        </div>
      </div>-->
    </div>
  </div>


  <!--按钮END-->
  <div class="modal fade" id="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h4 class="modal-title text-center">添加处方</h4>
        </div>
        <div class="modal-body">
          <form class="form-horizontal" role="form">
            <div class="form-group">
              <div class="col-sm-2 text-right"><label for="inputEmail3" class="control-label">选择处方</label></div>
              <div class="col-sm-10">
                <select id="chufanglist" class="form-control">
                   <option ng-repeat="x in options" value="{{x.id}}">{{x.name}}</option>
                </select>
              </div>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <a class="btn btn-default" data-dismiss="modal">取消</a>
          <a class="btn btn-primary" ng-click='addChufangObj()'>添加</a>
        </div>
      </div>
    </div>
  </div>
  <script>
  </script>
  <!--脚本-->
  <script type="text/javascript" src="../../Scripts/jquery-1.10.1.js"></script>
  <script type="text/javascript" src="../../Scripts/jquery.datetimepicker.full.min.js"></script>
  <script type="text/javascript" src="../../Scripts/angular.js"></script>
  <script type="text/javascript" src="../../Scripts/bootstrap.js"></script>
  <script type="text/javascript" src="../../Scripts/select2.js"></script>
  <script type="text/javascript" src="../../Scripts/bootstrap-paginator.js"></script>
  <script type="text/javascript" src="../../Scripts/CommonScript.js"></script>
  <!--自定义脚本部分-->
  <script>
    var app = angular.module('myApp', []);
    app.controller('customersCtrl', function($scope, $http) {

      var chufangurl = BasicUrl + "prescription?page=0&pageNum=10";
      $http.get(chufangurl).success(function(data) {
        if (data != null && data != "" && data != "null") {
          $scope.options = data.content;
        }
      });
      var reportObj = new UrlSearch();
      if (reportObj.id) {
        $scope.reportId = reportObj.id;
        var url = BasicUrl + "report/" + reportObj.id;
        $http.get(url).success(function(data) {
          if (data != null && data != "" && data != "null" && data.id) {
            $scope.data = data;
            $scope.expertData = {
              sportReport: "",
              sportAdvice: "",
              sportUrl: "",
              sportId: 0,
              foodReport: "",
              foodAdvice: "",
              foodUrl: "",
              foodId: 0
            };

            $scope.foodChufangArr = [];
            $scope.sportChufangArr = [];

            if (data.consults && data.consults.length > 0) {
              for (var index = 0; index < data.consults.length; index++) {
                var element = data.consults[index];
                if (element.admin.role == 2) {
                  $scope.expertData.sportReport = element.analysis;
                  $scope.expertData.sportAdvice = element.advice;
                  $scope.expertData.sportUrl = element.admin.iconUrl;
                  $scope.expertData.sportId = element.id;
                  $scope.sportChufangArr = element.prescriptions;
                }
                if (element.admin.role == 3) {
                  $scope.expertData.foodReport = element.analysis;
                  $scope.expertData.foodAdvice = element.advice;
                  $scope.expertData.foodUrl = element.admin.iconUrl;
                  $scope.expertData.foodId = element.id;
                  $scope.foodChufangArr = element.prescriptions;
                }
              }

            }

          } else {
            tool.alert("提示", data.errorMessage);
          }
        }).error(function(data, header, config, status) {
          //处理响应失败
          //   tool.alert("提示", "获取数据出错,请重试或联系网站管理员。");
          window.location.href = "MemberList.html";
        });
      } else {
        tool.alert("提示", "参数错误,当前无法获取数据!");
      }

      //报告分析
      $scope.editReport = function(content, type) {
        if (content) {
          var htmlstr = '<textarea rows="5" id="editReport" class="form-control" placeholder="请w输入修改内容">' + content + '</textarea>'
        } else {
          var htmlstr = '<textarea rows="5" class="form-control" id="editReport" placeholder="请输入修改内容">' + '</textarea>'
        }

        tool.confirm("请修改内容", htmlstr, function() {
          var vals = window.top.$("#editReport").val();
          // $scope.data.consults.analysis = vals;
          $scope.expertData[type + 'Report'] = vals;
          $scope.$apply();
        }, function() {

        })
      }

      //修改建议
      $scope.editAdvice = function(content, type) {
        if (content) {
          var htmlstr = '<textarea rows="5" id="adviceContent" class="form-control" placeholder="请输入修改内容">' + content + '</textarea>'
        } else {
          var htmlstr = '<textarea rows="5" class="form-control" id="adviceContent" placeholder="请输入修改内容">' + '</textarea>'
        }

        tool.confirm("请修改内容", htmlstr, function() {
          var val = window.top.$("#adviceContent").val();
          $scope.expertData[type + 'Advice'] = val;
          $scope.$apply();
        }, function() {

        })

      }


      // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆   
      // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆
      // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆
      // ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆

      $scope.addChufang = function(id, type) {
        $scope.expertAdviceReportId = id;
        $scope.expertType = type;
      }
      $scope.addChufangObj = function() {

        var chufangID = $("#chufanglist").val();
        $.ajax({
          type: "POST",
          url: BasicUrl + "report/" + $scope.reportId + "/consult/" + $scope.expertAdviceReportId + "/prescription",
          data: {
            reportId: $scope.reportId - 0,
            consultId: $scope.expertAdviceReportId,
            prescriptionId: chufangID
          },
          dataType: "json",
          error: function(response) {
            if (response && response.responseText && JSON.parse(response.responseText) && JSON.parse(response.responseText).errorMessage) {
              tool.alert("提示", JSON.parse(response.responseText).errorMessage);
            }
          },
          success: function(data) {

          },
          complete: function(xhr, textStatus) {
            if (xhr.status == 200) {
              if (xhr.responseText && JSON.parse(xhr.responseText) && JSON.parse(xhr.responseText).errorMessage) {
                tool.alert("提示", JSON.parse(xhr.responseText).errorMessage);
              } else {
                tool.alert("提示", "添加成功", function() {
                  //根据添加的类别进行判断然后添加数据
                  if ($scope.expertType == 'food') {
                    $scope.foodChufangArr.push($scope.getChufangObj(chufangID));
                    $scope.$apply();
                    $('#modal').modal('hide');
                  }
                  if ($scope.expertType == 'sport') {
                    $scope.sportChufangArr.push($scope.getChufangObj(chufangID));
                    $scope.$apply();
                    $('#modal').modal('hide');
                  }
                });
              }
            }
          }
        });


      }
      $scope.publishReport = function(type) {

        tool.confirm(
          "提示",
          "确认发布报告？",
          function() {
            //用户点击确认按钮时操作
            $.ajax({
              type: "PATCH",
              url: BasicUrl + "report/" + $scope.reportId + "/publish",
              data: {
                adminId: 1,
                id: $scope.reportId
              },
              dataType: "json",
              error: function(response) {
                if (response && response.responseText && JSON.parse(response.responseText) && JSON.parse(response.responseText).errorMessage) {
                  tool.alert("提示", JSON.parse(response.responseText).errorMessage);
                }
              },
              success: function(data) {

              },
              complete: function(xhr, textStatus) {
                if (xhr.status == 200) {
                  if (xhr.responseText && JSON.parse(xhr.responseText) && JSON.parse(xhr.responseText).errorMessage) {
                    tool.alert("提示", JSON.parse(xhr.responseText).errorMessage);
                  } else {
                    tool.alert("提示", "发布成功", function() {
                      //刷新当前页面.
                      window.location.reload();
                    });
                  }


                }
              }
            });
          },
          function() {
            //用户点击取消按钮时操作
          });
      }

      $scope.addConsult = function(type) {
        var adminId = 0; // TODO以后修改
        var chufang = [];
        if (type == 'food') {
          adminId = 10;
          for (var o = 0; o < $scope.foodChufangArr.length; o++) {
            var ele = $scope.foodChufangArr[o];
            chufang.push(ele.id);
          }

        } else if (type == 'sport') {
          adminId = 4
          for (var o = 0; o < $scope.sportChufangArr.length; o++) {
            var ele = $scope.sportChufangArr[o];
            chufang.push(ele.id);
          }


        }
        tool.confirm(
          "提示",
          "确认添加建议？",
          function() {
            $.ajax({
              type: "POST",
              url: BasicUrl + "report/" + $scope.reportId + "/consult",
              data: {
                reportId: $scope.reportId - 0,
                adminId: adminId, //TODO  修改
                analysis: $scope.expertData[type + 'Report'],
                advice: $scope.expertData[type + 'Advice'],
                prescriptions: chufang.join(','), //处方
                attach: "" //附件
              },
              dataType: "json",
              error: function(response) {
                if (response && response.responseText && JSON.parse(response.responseText) && JSON.parse(response.responseText).errorMessage) {
                  tool.alert("提示", JSON.parse(response.responseText).errorMessage);
                }
              },
              success: function(data) {

              },
              complete: function(xhr, textStatus) {
                if (xhr.status == 200) {
                  if (xhr.responseText && JSON.parse(xhr.responseText) && JSON.parse(xhr.responseText).errorMessage) {
                    tool.alert("提示", JSON.parse(xhr.responseText).errorMessage);
                  } else {
                    tool.alert("提示", "发布成功", function() {
                      //刷新当前页面.
                      window.location.reload();
                    });
                  }
                }
              }
            });

          },
          function() {

          });
      }


      $scope.getChufangObj = function(id) {
        var newObj = {};
        for (var index = 0; index < $scope.options.length; index++) {
          var element = $scope.options[index];
          if (element.id == id) {
            newObj.id = id;
            newObj.name = element.name;
            newObj.spell = element.spell;
            newObj.prescriptionType = element.prescriptionType;
          }
        }
        return newObj;
      }
    });
  </script>
</body>

</html>