<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>验单列表</title>
  <link href="../../Styles/bootstrap-3.3.4.css" rel="stylesheet" type="text/css">
  <link href="../../Styles/jquery.datetimepicker.css" rel="stylesheet" type="text/css">
  <link href="../../Styles/select2.min.css" rel="stylesheet" type="text/css">
  <!-- 个人维护样式库 -->
  <link href="../../Styles/common.css" rel="stylesheet">

  <style>
    .form-inline .form-control {
      width: auto;
    }
  </style>
</head>

<body ng-app="myApp">
  <!--检索项-->
  <div ng-controller="customersCtrl" class="container-fluid">
    <!-- 面包屑导航 -->
    <ol class="breadcrumb col-xs-12" style="border-radius:0;background-color:white;">
      <li><a href="javascript:void(0)">会员报告</a></li>
      <li class="active">验单详情</li>
    </ol>
    <div class="row form-inline">
      <div class="col-md-2"><img src="{{data.picUrl[0]}}" alt="" class="img-responsive img-thumbnail" ng-click="seeDetail(data.picUrl[0])"></div>
      <div class="col-md-10">
        <p>会员姓名：{{data.user.userName}}　　　　　　性别：{{data.user.gender=="M"?"男":"女"}}　　　　　　手机：{{data.user.realName}}</p>
        <p>验单评估：
          <input type="radio" name="isValid" value="1" checked ng-model="isuse">有效验单&nbsp;&nbsp;&nbsp;&nbsp;
          <input type="radio" name="isValid" value="0" ng-model="isuse">无效验单</p>
        <div ng-show="isuse>0">

          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                验单名称：
                <input type="text" name="" value="" class="form-control" placeholder="验单名称" ng-model="data.name"></div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                来源名称：<input type="text" id="reportFrom" name="reportFrom" class="form-control" ng-model="data.reportFrom" placeholder="医院或体检中心名称"></div>
            </div>

          </div>
          <div class="row" style="margin-top:10px;">
            <div class="col-md-4">
              <div class="form-group">
                验单日期：

                <input id="txtStartTime" name="minExpiredAt" class="start_end_time form-control" placeholder="开始时间" value="{{data.createAt|date:'yyyy/MM/dd HH:mm:ss'}}">

              </div>
            </div>

          </div>
          <div class="row" style="margin-top:10px;">
            <div class="col-md-4">
              <div class="form-group">
                报告单号：
                <input type="text" class="form-control" placeholder="报告单号" id="inspectionNo" ng-model="data.inspectionNo"></div>
            </div>
            <div class="col-md-4">
              <button type="button" class="btn btn-primary" ng-click="merge()">合并报告单</button>&nbsp;&nbsp;
              <button type="button" class="btn btn-primary" ng-click="addNew()">新建报告单</button>
            </div>
          </div>

        </div>
        <div ng-show="isuse==0">
          <p>无效原因：
            <input type="radio" name="reason" ng-model="reason" value="非本人验单">非本人验单&nbsp;&nbsp;
            <input type="radio" name="reason" ng-model="reason" value="验单超三个月期限">验单超三个月期限&nbsp;&nbsp;
            <input type="radio" name="reason" ng-model="reason" value="非可识别验单">非可识别验单&nbsp;&nbsp;</p>
          <div class="col-md-6">
            <button type="button" class="btn btn-primary" ng-click="notUseClick()">保存</button>
          </div>
          <script>
          </script>
        </div>
      </div>
    </div>
    <hr>
    <!--脚本-->
    <script type="text/javascript" src="../../Scripts/jquery-1.10.1.js"></script>
    <script type="text/javascript" src="../../Scripts/jquery.datetimepicker.full.min.js"></script>
    <script type="text/javascript" src="../../Scripts/angular.js"></script>
    <script type="text/javascript" src="../../Scripts/bootstrap.js"></script>
    <script type="text/javascript" src="../../Scripts/select2.full.min.js"></script>
    <script type="text/javascript" src="../../Scripts/bootstrap-paginator.js"></script>
    <script type="text/javascript" src="../../Scripts/CommonScript.js"></script>
    <script>
      $(function() {});
      // keyWord=&adviserId=&minCreatedAt=&maxCreatedAt=
      var params = ""; //全局变量  请求的参数
      var app = angular.module('myApp', []);
      app.controller('customersCtrl', function($scope, $http) {
        $scope.isuse = "1";
        var checkObj = new UrlSearch();
        if (checkObj.id) {
          //请求参数
          var url = BasicUrl + "inspection/" + checkObj.id;
          $http.get(url).success(function(data) {
            if (data != null && data != "" && data != "null" && data.id) {
              $scope.data = data;
            } else {
              tool.alert("提示", data.errorMessage);
            }
          }).error(function(data, header, config, status) {
            //处理响应失败
            tool.alert("提示", "获取数据出错,请重试或联系网站管理员。");
            window.location.href = "MemberList.html";
          });
        } else {
          tool.alert("提示", "获取参数出错，请重试！", function() {});
          window.history.back(-1);

        }

        //无效
        $scope.notUseClick = function() {
          var minExpiredAt = Date.parse(new Date($("#txtStartTime").val())).toString() == "NaN" ? 0 : Date.parse(new Date($("#txtStartTime").val()));
          $.ajax({
            type: "PATCH",
            url: BasicUrl + 'inspection/' + checkObj.id,
            data: {
              id: checkObj.id,
              isValid: false,
              inspectionNo: $("#inspectionNo").val(),
              name: $scope.data.name,
              reportFrom: $("#reportFrom").val(),
              checkAt: minExpiredAt,
              invalidReason: $('input:radio[name="reason"]:checked').val()
            },
            dataType: "json",
            error: function(response) {
              if (response && response.responseText && JSON.parse(response.responseText) && JSON.parse(response.responseText).errorMessage) {
                tool.alert("提示", JSON.parse(response.responseText).errorMessage);
              }
            },
            success: function(data) {

            },
            complete: function(xhr, textStatus) {
              if (xhr.status == 204 || xhr.status == 200) {
                if (xhr.responseText && JSON.parse(xhr.responseText) && JSON.parse(xhr.responseText).errorMessage) {
                  tool.alert("提示", JSON.parse(xhr.responseText).errorMessage);
                } else {
                  tool.alert("提示", "保存成功", function() {
                    //刷新当前页面.
                    window.location.href = "VipReport/CheckLists.html";
                  });
                }
              }
            }
          });
        }

        //合并
        $scope.merge = function() {
          tool.confirm(
            "提示",
            "确认合并报告单？",
            function() {
              //用户点击确认按钮时操作
              var minExpiredAt = Date.parse(new Date($("#txtStartTime").val())).toString() == "NaN" ? 0 : Date.parse(new Date($("#txtStartTime").val()));
              $.ajax({
                type: "PATCH",
                url: BasicUrl + 'inspection/'+checkObj.id,
                data: {
                  id: checkObj.id,
                  isValid: true,
                  inspectionNo: $("#inspectionNo").val(),
                  name: $scope.data.name,
                  reportFrom: $("#reportFrom").val(),
                  checkAt: minExpiredAt,
                  invalidReason: "无"
                },
                dataType: "json",
                error: function(response) {
                  if (response && response.responseText && JSON.parse(response.responseText) && JSON.parse(response.responseText).errorMessage) {
                    tool.alert("提示", JSON.parse(response.responseText).errorMessage);
                  }
                },
                success: function(data) {

                },
                complete: function(xhr, textStatus) {
                  if (xhr.status == 204||xhr.status == 200) {
                    if (xhr.responseText && JSON.parse(xhr.responseText) && JSON.parse(xhr.responseText).errorMessage) {
                      tool.alert("提示", JSON.parse(xhr.responseText).errorMessage);
                    } else {
                      tool.alert("提示", "添加成功", function() {
                        //刷新当前页面.
                        window.location.reload();
                      });
                    }
                  }
                }
              });
            },
            function() {
              //用户点击取消按钮时操作

            });

        }

$scope.seeDetail = function(url) {
        tool.alert("图片详情", "<img src='" + url + "' class='img-responsive img-thumbnail' style='width:100%;height:auto;'/>", function() {}, 'col-md-6 col-md-offset-3');
      }
        //新建
        $scope.addNew = function() {

        }

      });
    </script>
</body>

</html>